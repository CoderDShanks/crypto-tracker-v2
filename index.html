<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Crypto Dividend Tracker</title>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Tailwind for quick styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: #f3f4f6; }
  </style>
</head>
<body class="font-sans">
  <div class="max-w-4xl mx-auto p-6">
    <h1 class="text-3xl font-bold mb-6 text-center">📊 Weekly Dividends</h1>

    <!-- Chart Container -->
    <div class="bg-white rounded-2xl shadow p-4 mb-8">
      <canvas id="dividendChart"></canvas>
    </div>

    <!-- Dividend Entry Form -->
    <div class="bg-white rounded-2xl shadow p-6 mb-8 grid grid-cols-1 md:grid-cols-3 gap-4">
      <div>
        <label class="block font-medium mb-1">Crypto</label>
        <select id="cryptoSelect" class="w-full p-2 border rounded">
          <option value="" disabled selected>Select...</option>
          <option value="pharaoh">Pharaoh</option>
          <option value="velodrome">Velodrome Finance</option>
        </select>
      </div>
      <div>
        <label class="block font-medium mb-1">Date</label>
        <input type="date" id="divDate" class="w-full p-2 border rounded" />
      </div>
      <div>
        <label class="block font-medium mb-1">Amount (USD)</label>
        <input type="number" id="divAmount" step="0.01" placeholder="e.g. 12.34"
               class="w-full p-2 border rounded" />
        <button id="addBtn"
                class="mt-4 w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700">
          Add Dividend
        </button>
      </div>
    </div>

    <!-- Table of Weekly Dividends -->
    <div class="bg-white rounded-2xl shadow p-4 overflow-x-auto">
      <table class="w-full table-auto text-sm">
        <thead class="bg-gray-100">
          <tr>
            <th class="p-2 text-left">Week</th>
            <th class="p-2 text-right">Pharaoh ($)</th>
            <th class="p-2 text-right">Velodrome ($)</th>
            <th class="p-2 text-right">Total ($)</th>
          </tr>
        </thead>
        <tbody id="dividendTable"></tbody>
      </table>
    </div>
  </div>

  <script>
    // ——— LocalStorage Helpers ———
    const LS_KEY = 'dividends_v2';
    const loadDivs = () => JSON.parse(localStorage.getItem(LS_KEY) || '[]');
    const saveDivs = arr => localStorage.setItem(LS_KEY, JSON.stringify(arr));

    // ——— Group by Calendar Week ———
    function groupByWeek(divs) {
      const weeks = {};
      divs.forEach(({ date, crypto, amount }) => {
        const dt = new Date(date);
        const day = dt.getDay();
        const diff = dt.getDate() - day + (day === 0 ? -6 : 1);
        const mon = new Date(dt.setDate(diff));
        const key = mon.toISOString().slice(0, 10);
        weeks[key] = weeks[key] || { pharaoh: 0, velodrome: 0 };
        weeks[key][crypto] += amount;
      });
      return Object
        .entries(weeks)
        .sort(([a], [b]) => a < b ? -1 : 1)
        .map(([week, obj]) => ({
          week,
          pharaoh: obj.pharaoh,
          velodrome: obj.velodrome,
          total: obj.pharaoh + obj.velodrome
        }));
    }

    // ——— Chart.js Setup ———
    const ctx = document.getElementById('dividendChart').getContext('2d');
    const dividendChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: [],
        datasets: [
          {
            label: 'Pharaoh',
            data: [],
            backgroundColor: 'rgba(239, 68, 68, 0.7)'
          },
          {
            label: 'Velodrome Finance',
            data: [],
            backgroundColor: 'rgba(59, 130, 246, 0.7)'
          }
        ]
      },
      options: {
        responsive: true,
        scales: {
          x: { stacked: true },
          y: { stacked: true, beginAtZero: true }
        }
      }
    });

    // ——— Render Chart + Table ———
    function render() {
      const data = groupByWeek(loadDivs());

      // Chart
      dividendChart.data.labels = data.map(d => d.week);
      dividendChart.data.datasets[0].data = data.map(d => d.pharaoh.toFixed(2));
      dividendChart.data.datasets[1].data = data.map(d => d.velodrome.toFixed(2));
      dividendChart.update();

      // Table
      const tbody = document.getElementById('dividendTable');
      tbody.innerHTML = '';
      data.forEach(d => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="p-2">${d.week}</td>
          <td class="p-2 text-right">${d.pharaoh.toFixed(2)}</td>
          <td class="p-2 text-right">${d.velodrome.toFixed(2)}</td>
          <td class="p-2 text-right font-semibold">${d.total.toFixed(2)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ——— Wire Up “Add” Button ———
    document.getElementById('addBtn').addEventListener('click', () => {
      const date    = document.getElementById('divDate').value;
      const crypto  = document.getElementById('cryptoSelect').value;
      const amount  = parseFloat(document.getElementById('divAmount').value);
      if (!date || !crypto || isNaN(amount)) {
        return alert('Please select a crypto, date, and enter a valid amount.');
      }
      const arr = loadDivs();
      arr.push({ date, crypto, amount });
      saveDivs(arr);
      render();
      // reset inputs
      document.getElementById('divAmount').value = '';
    });

    // ——— On Load ———
    document.getElementById('divDate').value = new Date().toISOString().slice(0, 10);
    render();
  </script>
</body>
</html>
